
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Amortization with Continuous Consistency Models &#8212; BayesFlow: Amortized Bayesian Inference</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=d6fb7fc6" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_examples/experimental/Continuous_Consistency_Model_Playground';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="canonical" href="https://www.bayesflow.org/_examples/experimental/Continuous_Consistency_Model_Playground.html" />
    <link rel="icon" href="../../_static/bayesflow_hex.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/bayesflow_hex.png" class="logo__image only-light" alt="BayesFlow: Amortized Bayesian Inference - Home"/>
    <script>document.write(`<img src="../../_static/bayesflow_hex.png" class="logo__image only-dark" alt="BayesFlow: Amortized Bayesian Inference - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">BayesFlow</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples.html">Examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Linear_Regression_Starter.html">1. Amortized Posterior Estimation for Linear Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Two_Moons_Starter.html">2. Two Moons: Tackling Bimodal Posteriors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../SIR_Posterior_Estimation.html">3. Posterior Estimation for SIR-like Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Hyperparameter_Optimization.html">4. Hyperparameter Optimization Using Optuna</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Bayesian_Experimental_Design.html">5. Bayesian Experimental Design (BED) with BayesFlow and PyTorch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../From_ABC_to_BayesFlow.html">6. From pyABC to BayesFlow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../One_Sample_TTest.html">7. Simple Model Comparison - One Sample T-Test</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/bayesflow.html">API Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/bayesflow.adapters.html">adapters</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.adapters.Adapter.html">Adapter</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.html">transforms</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.Constrain.html">Constrain</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.Drop.html">Drop</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.Rename.html">Rename</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.Keep.html">Keep</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.AsSet.html">AsSet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.ElementwiseTransform.html">ElementwiseTransform</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.ToArray.html">ToArray</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.Standardize.html">Standardize</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.LambdaTransform.html">LambdaTransform</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.AsTimeSeries.html">AsTimeSeries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.Broadcast.html">Broadcast</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.Concatenate.html">Concatenate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.ExpandDims.html">ExpandDims</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.MapTransform.html">MapTransform</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.OneHot.html">OneHot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.Transform.html">Transform</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.FilterTransform.html">FilterTransform</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/bayesflow.adapters.transforms.ConvertDType.html">ConvertDType</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/bayesflow.approximators.html">approximators</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.approximators.Approximator.html">Approximator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.approximators.ContinuousApproximator.html">ContinuousApproximator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.approximators.ModelComparisonApproximator.html">ModelComparisonApproximator</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/bayesflow.benchmarks.html">benchmarks</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.benchmarks.TwoMoons.html">TwoMoons</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.benchmarks.LotkaVolterra.html">LotkaVolterra</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/bayesflow.datasets.html">datasets</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.datasets.RoundsDataset.html">RoundsDataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.datasets.DiskDataset.html">DiskDataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.datasets.OfflineDataset.html">OfflineDataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.datasets.OnlineDataset.html">OnlineDataset</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/bayesflow.diagnostics.html">diagnostics</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/bayesflow.distributions.html">distributions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.distributions.DiagonalStudentT.html">DiagonalStudentT</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.distributions.DiagonalNormal.html">DiagonalNormal</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.distributions.Distribution.html">Distribution</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/bayesflow.experimental.html">experimental</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.experimental.CIF.html">CIF</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.experimental.ContinuousTimeConsistencyModel.html">ContinuousTimeConsistencyModel</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/bayesflow.metrics.html">metrics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.metrics.MaximumMeanDiscrepancy.html">MaximumMeanDiscrepancy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.metrics.RootMeanSquaredError.html">RootMeanSquaredError</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.metrics.functional.html">functional</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/bayesflow.networks.html">networks</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.networks.FreeFormFlow.html">FreeFormFlow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.networks.FusionTransformer.html">FusionTransformer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.networks.LSTNet.html">LSTNet</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.networks.TimeSeriesTransformer.html">TimeSeriesTransformer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.networks.DeepSet.html">DeepSet</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.networks.FlowMatching.html">FlowMatching</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.networks.MLP.html">MLP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.networks.ConsistencyModel.html">ConsistencyModel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.networks.SetTransformer.html">SetTransformer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.networks.InferenceNetwork.html">InferenceNetwork</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.networks.SummaryNetwork.html">SummaryNetwork</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.networks.CouplingFlow.html">CouplingFlow</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/bayesflow.simulators.html">simulators</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.simulators.SequentialSimulator.html">SequentialSimulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.simulators.HierarchicalSimulator.html">HierarchicalSimulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.simulators.ModelComparisonSimulator.html">ModelComparisonSimulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.simulators.LambdaSimulator.html">LambdaSimulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.simulators.TwoMoons.html">TwoMoons</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.simulators.Simulator.html">Simulator</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/bayesflow.types.html">types</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/bayesflow.utils.html">utils</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.utils.numpy_utils.html">numpy_utils</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.utils.keras_utils.html">keras_utils</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.utils.logging.html">logging</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/bayesflow.workflows.html">workflows</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/bayesflow.workflows.BasicWorkflow.html">BasicWorkflow</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About us</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing to BayesFlow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Patterns &amp; Caveats</a></li>
</ul>

    </div>
</nav></div>
        <div class="sidebar-primary-item">
<div class="rst-versions">
  
   
  <p class="caption" aria-level="2" role="heading"><span class="caption-text">Branches</span></p>
  <ul>
      <li><a href="/dev/_examples/experimental/Continuous_Consistency_Model_Playground.html" class="current">dev</a></li>
  </ul>
  
</div>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/bayesflow-org/bayesflow" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/bayesflow-org/bayesflow/edit/master/_examples/experimental/Continuous_Consistency_Model_Playground.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/bayesflow-org/bayesflow/issues/new?title=Issue%20on%20page%20%2F_examples/experimental/Continuous_Consistency_Model_Playground.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/_examples/experimental/Continuous_Consistency_Model_Playground.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

  
<div id="searchbox"></div>
  <article class="bd-article">




<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Amortization...</li>
  </ul>
</nav>

    
  <section class="tex2jax_ignore mathjax_ignore" id="amortization-with-continuous-consistency-models">
<h1>Amortization with Continuous Consistency Models<a class="headerlink" href="#amortization-with-continuous-consistency-models" title="Link to this heading">#</a></h1>
<p><em>Author: Valentin Pratz</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="c1"># Ensure the backend is set</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="k">if</span> <span class="s2">&quot;KERAS_BACKEND&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="c1"># set this to &quot;torch&quot;, &quot;tensorflow&quot;, or &quot;jax&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;KERAS_BACKEND&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;jax&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">keras</span>

<span class="c1"># For BayesFlow devs: this ensures that the latest dev version can be found</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;../..&quot;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">bayesflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bayesflow.experimental.continuous_time_consistency_model</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ContinuousTimeConsistencyModel</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This notebook serves as a playground for testing continuous-time consistency models. They are still experimental, as they are not fully tested yet, so please use them at your own discretion and share potential successes/failures. This will help us to judge their usefulness in the context of SBI. Later on, this notebook might evolve into a full tutorial notebook. For now, please refer to the starter notebook if you encounter concepts that are not explained.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulator</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">simulators</span><span class="o">.</span><span class="n">TwoMoons</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Letâ€™s generate some data to see what the simulator does:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate 3 random draws from the joint distribution p(r, alpha, theta, x)</span>
<span class="n">sample_data</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="mi">20</span><span class="p">,))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Type of sample_data:</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">sample_data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Keys of sample_data:</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Types of sample_data values:</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shapes of sample_data values:</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Type of sample_data:
	 &lt;class &#39;dict&#39;&gt;
Keys of sample_data:
	 dict_keys([&#39;r&#39;, &#39;alpha&#39;, &#39;theta&#39;, &#39;x&#39;])
Types of sample_data values:
	 {&#39;r&#39;: &lt;class &#39;numpy.ndarray&#39;&gt;, &#39;alpha&#39;: &lt;class &#39;numpy.ndarray&#39;&gt;, &#39;theta&#39;: &lt;class &#39;numpy.ndarray&#39;&gt;, &#39;x&#39;: &lt;class &#39;numpy.ndarray&#39;&gt;}
Shapes of sample_data values:
	 {&#39;r&#39;: (20, 1), &#39;alpha&#39;: (20, 1), &#39;theta&#39;: (20, 2), &#39;x&#39;: (20, 2)}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">bf</span><span class="o">.</span><span class="n">adapters</span><span class="o">.</span><span class="n">Adapter</span><span class="p">()</span>
    <span class="c1"># drop data that we do not need</span>
    <span class="o">.</span><span class="n">keep</span><span class="p">((</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">))</span>
    <span class="c1"># convert any non-arrays to numpy arrays</span>
    <span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
    <span class="c1"># convert from numpy&#39;s default float64 to deep learning friendly float32</span>
    <span class="o">.</span><span class="n">convert_dtype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="c1"># standardize all variables to zero mean and unit variance</span>
    <span class="o">.</span><span class="n">standardize</span><span class="p">(</span><span class="n">momentum</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="c1"># rename the variables to match the required approximator inputs</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="s2">&quot;inference_variables&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;inference_conditions&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">adapter</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Adapter([0: Keep([&#39;theta&#39;, &#39;x&#39;]) -&gt; 1: ToArray -&gt; 2: ConvertDType -&gt; 3: Standardize -&gt; 4: Rename(&#39;theta&#39; -&gt; &#39;inference_variables&#39;) -&gt; 5: Rename(&#39;x&#39; -&gt; &#39;inference_conditions&#39;)])
</pre></div>
</div>
</div>
</div>
<section id="dataset">
<h2>Dataset<a class="headerlink" href="#dataset" title="Link to this heading">#</a></h2>
<p>For this example, we will sample our training data ahead of time and use offline training with a <code class="docutils literal notranslate"><span class="pre">bf.datasets.OfflineDataset</span></code>.</p>
<p>This makes the training process faster, since we avoid repeated sampling. If you want to use online training, you can use an <code class="docutils literal notranslate"><span class="pre">OnlineDataset</span></code> analogously, or just pass your simulator directly to <code class="docutils literal notranslate"><span class="pre">approximator.fit()</span></code>!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_training_batches</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">num_validation_batches</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">total_steps</span> <span class="o">=</span> <span class="n">num_training_batches</span> <span class="o">*</span> <span class="n">epochs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">training_samples</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">num_training_batches</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,))</span>
<span class="n">validation_samples</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">num_validation_batches</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">training_dataset</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">OfflineDataset</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">training_samples</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">adapter</span><span class="o">=</span><span class="n">adapter</span>
<span class="p">)</span>

<span class="n">validation_dataset</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">OfflineDataset</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">validation_samples</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">adapter</span><span class="o">=</span><span class="n">adapter</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="training-a-neural-network-to-approximate-all-posteriors">
<h2>Training a neural network to approximate all posteriors<a class="headerlink" href="#training-a-neural-network-to-approximate-all-posteriors" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inference_network</span> <span class="o">=</span> <span class="n">ContinuousTimeConsistencyModel</span><span class="p">(</span>
    <span class="n">subnet</span><span class="o">=</span><span class="s2">&quot;mlp&quot;</span><span class="p">,</span>
    <span class="n">sigma_data</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># as we have standardized our parameters, the standard deviation is 1.0</span>
    <span class="n">subnet_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;widths&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">256</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s2">&quot;dropout&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="p">},</span>  <span class="c1"># use an inner network with 6 hidden layers of 256 units</span>
    <span class="n">embedding_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;embed_dim&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bayesflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">experimental</span>
</pre></div>
</div>
</div>
</div>
<p>This inference network is just a general Flow Matching backbone, not yet adapted to the specific inference task at hand (i.e., posterior appproximation). To achieve this adaptation, we combine the network with our data adapter, which together form an <code class="docutils literal notranslate"><span class="pre">approximator</span></code>. In this case, we need a <code class="docutils literal notranslate"><span class="pre">ContinuousApproximator</span></code> since the target we want to approximate is the posterior of the <em>continuous</em> parameter vector <span class="math notranslate nohighlight">\(\theta\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cm_approximator</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">ContinuousApproximator</span><span class="p">(</span>
    <span class="n">inference_network</span><span class="o">=</span><span class="n">inference_network</span><span class="p">,</span>
    <span class="n">adapter</span><span class="o">=</span><span class="n">adapter</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="optimizer-and-learning-rate">
<h3>Optimizer and Learning Rate<a class="headerlink" href="#optimizer-and-learning-rate" title="Link to this heading">#</a></h3>
<p>We find learning rate schedules, such as <a class="reference external" href="https://keras.io/api/optimizers/learning_rate_schedules/cosine_decay/">cosine decay</a>, work well for a wide variety of approximation tasks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">initial_learning_rate</span> <span class="o">=</span> <span class="mf">5e-4</span>
<span class="n">scheduled_lr</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">schedules</span><span class="o">.</span><span class="n">CosineDecay</span><span class="p">(</span>
    <span class="n">initial_learning_rate</span><span class="o">=</span><span class="n">initial_learning_rate</span><span class="p">,</span> <span class="n">decay_steps</span><span class="o">=</span><span class="n">total_steps</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-8</span>
<span class="p">)</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">scheduled_lr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cm_approximator</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="training">
<h3>Training<a class="headerlink" href="#training" title="Link to this heading">#</a></h3>
<p>We are ready to train our deep posterior approximator on the two moons example. We pass the dataset object to the <code class="docutils literal notranslate"><span class="pre">fit</span></code> method and watch as Bayesflow trains.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">fm_history</span> <span class="o">=</span> <span class="n">cm_approximator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
    <span class="n">dataset</span><span class="o">=</span><span class="n">training_dataset</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_dataset</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># set verbose=2 to avoid flooding the notebook</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:bayesflow:Fitting on dataset instance of OfflineDataset.
INFO:bayesflow:Building on a test batch.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/30
512/512 - 4s - 7ms/step - loss: -9.3843e-01 - loss/inference_loss: -9.3843e-01 - val_loss: -9.1318e-01 - val_loss/inference_loss: -9.1318e-01
Epoch 2/30
512/512 - 3s - 5ms/step - loss: -9.9757e-01 - loss/inference_loss: -9.9757e-01 - val_loss: -1.0789e+00 - val_loss/inference_loss: -1.0789e+00
Epoch 3/30
512/512 - 2s - 5ms/step - loss: -9.7956e-01 - loss/inference_loss: -9.7956e-01 - val_loss: -1.0510e+00 - val_loss/inference_loss: -1.0510e+00
Epoch 4/30
512/512 - 3s - 5ms/step - loss: -1.0268e+00 - loss/inference_loss: -1.0268e+00 - val_loss: -1.0437e+00 - val_loss/inference_loss: -1.0437e+00
Epoch 5/30
512/512 - 3s - 5ms/step - loss: -1.0449e+00 - loss/inference_loss: -1.0449e+00 - val_loss: -9.4702e-01 - val_loss/inference_loss: -9.4702e-01
Epoch 6/30
512/512 - 2s - 5ms/step - loss: -9.5895e-01 - loss/inference_loss: -9.5895e-01 - val_loss: -9.5736e-01 - val_loss/inference_loss: -9.5736e-01
Epoch 7/30
512/512 - 2s - 5ms/step - loss: -9.3300e-01 - loss/inference_loss: -9.3300e-01 - val_loss: -1.1226e+00 - val_loss/inference_loss: -1.1226e+00
Epoch 8/30
512/512 - 2s - 5ms/step - loss: -9.3088e-01 - loss/inference_loss: -9.3088e-01 - val_loss: -1.1311e+00 - val_loss/inference_loss: -1.1311e+00
Epoch 9/30
512/512 - 2s - 5ms/step - loss: -9.3398e-01 - loss/inference_loss: -9.3398e-01 - val_loss: -1.0012e+00 - val_loss/inference_loss: -1.0012e+00
Epoch 10/30
512/512 - 2s - 5ms/step - loss: -9.5127e-01 - loss/inference_loss: -9.5127e-01 - val_loss: -1.1021e+00 - val_loss/inference_loss: -1.1021e+00
Epoch 11/30
512/512 - 2s - 5ms/step - loss: -1.0212e+00 - loss/inference_loss: -1.0212e+00 - val_loss: -9.9398e-01 - val_loss/inference_loss: -9.9398e-01
Epoch 12/30
512/512 - 3s - 5ms/step - loss: -1.1326e+00 - loss/inference_loss: -1.1326e+00 - val_loss: -9.5806e-01 - val_loss/inference_loss: -9.5806e-01
Epoch 13/30
512/512 - 3s - 5ms/step - loss: -1.0533e+00 - loss/inference_loss: -1.0533e+00 - val_loss: -9.8955e-01 - val_loss/inference_loss: -9.8955e-01
Epoch 14/30
512/512 - 3s - 5ms/step - loss: -1.0783e+00 - loss/inference_loss: -1.0783e+00 - val_loss: -1.1011e+00 - val_loss/inference_loss: -1.1011e+00
Epoch 15/30
512/512 - 3s - 5ms/step - loss: -1.0251e+00 - loss/inference_loss: -1.0251e+00 - val_loss: -1.1740e+00 - val_loss/inference_loss: -1.1740e+00
Epoch 16/30
512/512 - 3s - 5ms/step - loss: -1.0389e+00 - loss/inference_loss: -1.0389e+00 - val_loss: -1.1353e+00 - val_loss/inference_loss: -1.1353e+00
Epoch 17/30
512/512 - 3s - 5ms/step - loss: -1.0906e+00 - loss/inference_loss: -1.0906e+00 - val_loss: -1.1350e+00 - val_loss/inference_loss: -1.1350e+00
Epoch 18/30
512/512 - 2s - 5ms/step - loss: -1.1508e+00 - loss/inference_loss: -1.1508e+00 - val_loss: -1.0663e+00 - val_loss/inference_loss: -1.0663e+00
Epoch 19/30
512/512 - 2s - 5ms/step - loss: -1.0334e+00 - loss/inference_loss: -1.0334e+00 - val_loss: -1.1079e+00 - val_loss/inference_loss: -1.1079e+00
Epoch 20/30
512/512 - 3s - 5ms/step - loss: -1.1104e+00 - loss/inference_loss: -1.1104e+00 - val_loss: -1.1154e+00 - val_loss/inference_loss: -1.1154e+00
Epoch 21/30
512/512 - 3s - 5ms/step - loss: -1.0883e+00 - loss/inference_loss: -1.0883e+00 - val_loss: -1.1937e+00 - val_loss/inference_loss: -1.1937e+00
Epoch 22/30
512/512 - 2s - 5ms/step - loss: -1.1893e+00 - loss/inference_loss: -1.1893e+00 - val_loss: -1.1405e+00 - val_loss/inference_loss: -1.1405e+00
Epoch 23/30
512/512 - 2s - 5ms/step - loss: -1.2122e+00 - loss/inference_loss: -1.2122e+00 - val_loss: -1.1151e+00 - val_loss/inference_loss: -1.1151e+00
Epoch 24/30
512/512 - 2s - 5ms/step - loss: -1.0478e+00 - loss/inference_loss: -1.0478e+00 - val_loss: -1.1214e+00 - val_loss/inference_loss: -1.1214e+00
Epoch 25/30
512/512 - 2s - 5ms/step - loss: -1.1838e+00 - loss/inference_loss: -1.1838e+00 - val_loss: -1.1838e+00 - val_loss/inference_loss: -1.1838e+00
Epoch 26/30
512/512 - 2s - 5ms/step - loss: -1.1238e+00 - loss/inference_loss: -1.1238e+00 - val_loss: -1.1740e+00 - val_loss/inference_loss: -1.1740e+00
Epoch 27/30
512/512 - 2s - 5ms/step - loss: -1.1162e+00 - loss/inference_loss: -1.1162e+00 - val_loss: -1.0619e+00 - val_loss/inference_loss: -1.0619e+00
Epoch 28/30
512/512 - 2s - 5ms/step - loss: -1.2349e+00 - loss/inference_loss: -1.2349e+00 - val_loss: -1.1863e+00 - val_loss/inference_loss: -1.1863e+00
Epoch 29/30
512/512 - 3s - 5ms/step - loss: -1.3770e+00 - loss/inference_loss: -1.3770e+00 - val_loss: -1.2584e+00 - val_loss/inference_loss: -1.2584e+00
Epoch 30/30
512/512 - 3s - 5ms/step - loss: -1.1379e+00 - loss/inference_loss: -1.1379e+00 - val_loss: -1.1435e+00 - val_loss/inference_loss: -1.1435e+00
CPU times: user 2min 54s, sys: 10.6 s, total: 3min 4s
Wall time: 1min 17s
</pre></div>
</div>
</div>
</div>
<p>Note that after a certain time, the loss is no longer indicative of training performance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the number of posterior draws you want to get</span>
<span class="n">num_samples</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mf">3.5</span>

<span class="c1"># Obtain samples from amortized posterior</span>

<span class="n">conditions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)}</span>
<span class="n">samples_0</span> <span class="o">=</span> <span class="n">cm_approximator</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="n">conditions</span><span class="o">=</span><span class="n">conditions</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="n">rho</span>
<span class="p">)[</span><span class="s2">&quot;theta&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Prepare figure</span>
<span class="n">f</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot samples (once without limits to see outliers/problems</span>
<span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">samples_0</span><span class="p">,</span> <span class="n">samples_0</span><span class="p">]</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Continuous-time CM&quot;</span><span class="p">,</span> <span class="s2">&quot;Without Axis Limits&quot;</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#153c7a&quot;</span><span class="p">,</span> <span class="s2">&quot;#7a1515&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>

    <span class="c1"># Plot samples</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">thetas</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">thetas</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;without&quot;</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\theta_1$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\theta_2$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/85d14b61787e2b569a864f9b1d21e4320fdab4433d9e45c9b6e401b377f7c57a.png" src="../../_images/85d14b61787e2b569a864f9b1d21e4320fdab4433d9e45c9b6e401b377f7c57a.png" />
</div>
</div>
<p>Plot the discretization schedule:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">discretized_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">convert_to_numpy</span><span class="p">(</span>
        <span class="n">cm_approximator</span><span class="o">.</span><span class="n">inference_network</span><span class="o">.</span><span class="n">_discretize_time</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">discretized_time</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">discretized_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span>
    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\pi/8$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\pi/4$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$3\pi/8$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\pi/2$&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Discretization schedule&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2839199e85bb726f4206a7c17a328ea80358b35d8f5acc392a75b590d2f9fbc7.png" src="../../_images/2839199e85bb726f4206a7c17a328ea80358b35d8f5acc392a75b590d2f9fbc7.png" />
</div>
</div>
<p>Plot the time embedding:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">500</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">emb</span> <span class="o">=</span> <span class="n">inference_network</span><span class="o">.</span><span class="n">time_emb</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">convert_to_numpy</span><span class="p">(</span><span class="n">t</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">keras</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">convert_to_numpy</span><span class="p">(</span><span class="n">emb</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;emb(t)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\pi/4$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\pi/2$&quot;</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Time embedding&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/9c83202d3dbe4456cb9c7b5aff95294a89f1019b23f0558b8e4eb48105c09b4e.png" src="../../_images/9c83202d3dbe4456cb9c7b5aff95294a89f1019b23f0558b8e4eb48105c09b4e.png" />
</div>
</div>
<p>Plot the learned adaptive weighting function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">inference_network</span><span class="o">.</span><span class="n">weight_fn_projector</span><span class="p">(</span><span class="n">inference_network</span><span class="o">.</span><span class="n">weight_fn</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">inference_network</span><span class="o">.</span><span class="n">sigma_data</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t</span><span class="p">,</span>
    <span class="n">inference_network</span><span class="o">.</span><span class="n">weight_fn_projector</span><span class="p">(</span><span class="n">inference_network</span><span class="o">.</span><span class="n">weight_fn</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
    <span class="o">/</span> <span class="p">(</span><span class="n">inference_network</span><span class="o">.</span><span class="n">sigma_data</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">t</span><span class="p">)),</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$w_\phi(t)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\pi/4$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\pi/2$&quot;</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Learned adaptive weighting function&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/965932361764c24e5514ef6801531719a197fb3508a1f35606c441fd5fcbf5b2.png" src="../../_images/965932361764c24e5514ef6801531719a197fb3508a1f35606c441fd5fcbf5b2.png" />
</div>
</div>
</section>
</section>
</section>


  </article>

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset">Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-a-neural-network-to-approximate-all-posteriors">Training a neural network to approximate all posteriors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizer-and-learning-rate">Optimizer and Learning Rate</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#training">Training</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The BayesFlow authors
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2023-2025, BayesFlow authors (lead maintainer: Stefan T. Radev).
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>